{% extends 'base_content.html' %}
{% block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<div class='row'>
    <div class="card full-card">
        <!-- Seach bar -->
        <form action="{% url 'search_expenditure' %}" method="GET">
            <input id="title" name="q" type="text" onblur="this.form.submit()" placeholder="Search by title">
            <button type="submit" class="btn btn-info btn-md">Go</button>
            <a class="btn btn-md btn-dark" href='{% url 'expenditure_list' %}'>Reset</a>
        </form>
        <!-- Drop down -->
        <form action="{% url 'search_category' %}" method="GET">
            <label for="category">Choose a category:</label>
            <select class="form-select" style="width:138px; display: inline-block;" id = "category" name="q" onchange="this.form.submit()" >
                <option>All</option>
                {% for category in categories %}
                    <option value= {{ category.id }}>{{category}}</option>
                {% endfor %}
            </select>
        </form>

        <script> 
        // $('#title').on('change', function() {
        //         // Save value in localstorage
        //         localStorage.setItem("title", $(this).val());
        // });
        $('#category').on('change', function() {
                // Save value in localstorage
                localStorage.setItem("category", $(this).val());
        });
        $(document).ready(function() {
            if (localStorage.getItem("category") ||  localStorage.getItem("title")) {
                $('#category').val(localStorage.getItem("category"));
                // $('#title').val(localStorage.getItem("title"));
            }
            if (performance.navigation.type == 1) {
                console.info( "This page is reloaded" );
            } else {
                localStorage.removeItem("title");
                // localStorage.removeItem("category"); // clear localstorage
                console.info( "This page is not reloaded");
            }
        });
        </script>

        <!-- table -->
        <form id="expenform" method="POST">
            {% csrf_token %}
        <table class="table mainTable">
            <div class="row">
                <div class="col-4">
                  <div class="d-grid gap-2 d-md-block">
                    <button type="button" name="delete" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete</button>
                  </div>
                </div>
                <div class="col-4">
                    <div class="d-grid gap-2 d-md-block">
                      <button type="button" name="edit" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal">Edit</button>
                    </div>
                </div>
            </div>
    </div>
            <thead class="mainThead">
                <tr>
                    <th scope="col" width="150px">Category</th>
                    <th scope="col" width="170px">Title</th>
                    <th scope="col" width="170px">Expense</th>
                    <th scope="col" width="200px">Time</th>
                    <th scope="col" width="330px">Description</th>
                    <th scope="col">Image</th>
                </tr>
            </thead>
            
          </div>
            <tbody class="mainTbody" >
                <div class="Spending">
                    {% for spending in spendings %}
                        <tr>
                            <!-- <td width="75px" value=spending.id id="checkbox" ><input type="checkbox"></td> -->
                            <th scope="row"> <input class = "form-check-input" type = "radio" name = "expenditure_pk" value = {{ spending.id }}></input> </th>
                            <td width="75px">{{ spending.category }}</td>
                            <td width="240px">{{ spending.title }}</td>
                            <td width="130px">Â£{{ spending.expense }}</td>
                            <td width="200px">{{ spending.date_created }}</td>
                            <td width="320px">{{ spending.description }}</td>
                            {% if spending.image %}
                            <!-- This code can show full images.
                                <td style="max-width:0px"><img src="media/{{ spending.image }} " alt="image"></td>
                            -->  
                                <td><a href="{{ spending.image.url }}">Click here to view the image</a></td>
                            {% else %}
                                <td><a> None </a></td>
                            {% endif %}
                            <!-- <th scope="row"><button class="btn btn-sm btn-info">Edit</button></th> -->
                        </tr>
                    {% endfor %}
                </div>
            </tbody>
        </table>
    </form>
    </div>
</div>

<!-- delete modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="deleteModalLabel">Delete Expenditure</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this expenditure?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger"  form="expenform" formaction = "../remove_expenditure" method="POST">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- edit modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="editModalLabel">Edit Expenditure</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        <form action="" method ="POST">
            {% csrf_token %}
            {{ form.as_p }} 
          <p>Are you sure you want to edit this expenditure?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success"  form="expenform" formaction = "../update_expenditure" method="POST">Confirm</button>
        </div>
    </form>
      </div>
    </div>
  </div>

{% endblock %}
