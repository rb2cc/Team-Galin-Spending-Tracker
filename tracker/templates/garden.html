{% extends 'base_content_garden.html' %}
{% load static %}
{% block content %}

<div class="card garden-card">
    <h2 style="text-align:center;">Contribute To Our Environmental Protection Projects Now!</h2>
    <p style="font-size:20px;">
        &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
        Our website is in cooperation with Galin Environmental Protection Company.
        You can use your points to redeem trees, which will be planted in the real world, on the Earth.
        Every single tree is traceable, and will be registered with your name.
        Welome to visit Galin Environmental Protection Company website to find out more information about this project!
    </p>
    <div class="row">
        <div class="col">
            <img src="{% static "images/garden.png" %}" class="centerImage">
        </div>
        <div class="col" style="padding-left:70px;padding-right:70px">
            <div style="padding-top:70px">*How to get points:</div>
            <li>Complete challenges</li>
            <li>Complete achievement</li>
            <li>Keep all categories under limit to get 10 points every week</li>
            <h2 style="padding-top:50px;padding-bottom:20px;font-size:40px">You have planted <span style="color:red">{{treeNum}}</span> Trees</h2>
            <strong style="font-size:20px">Total Point You Have Earned: {{pointTotal}}</strong>
            <p></p>
            <strong style="font-size:20px;">Points Available: {{pointLeft}}</strong>
            <form method="post">
                {% csrf_token %}
                <p></p>
                {% include 'partials/messages.html' %}
                <input type="submit" value="Spend 100 points to plant a tree!" class='btn btn-primary' name="plant">
            </form>
        </div>      
    </div>

    <div id="image-container"></div>


    <div id="drag-container" style="position: relative; width: 500px; height: 500px; border: 1px solid black;">
        <img id="drag-item" src="{% static 'images/smallTree.png' %}" style="position: absolute; top: {{ tree_position.y_position }}px; left:{{ tree_position.x_position }}px; width: 100px; height: 100px;">
      </div>
      
      <script>
        var dragItem = document.getElementById("drag-item");
        var dragContainer = document.getElementById("drag-container");
      
        {% if tree_position %}
            dragItem.style.top = "{{ tree_position.y_position }}px";
            dragItem.style.left = "{{ tree_position.x_position }}px";
        {% endif %}
      
        dragItem.addEventListener("mousedown", dragStart);
      
        function dragStart(event) {
          event.preventDefault();
          var initialTop = dragItem.offsetTop;
          var initialLeft = dragItem.offsetLeft;
          var offsetX = event.clientX - initialLeft;
          var offsetY = event.clientY - initialTop;
      
          document.addEventListener("mousemove", drag);
          document.addEventListener("mouseup", dragEnd);
      
          function drag(event) {
            event.preventDefault();
            var newTop = event.clientY - offsetY;
            var newLeft = event.clientX - offsetX;
            if (newTop >= 0 && newLeft >= 0 && newTop + dragItem.clientHeight <= dragContainer.clientHeight && newLeft + dragItem.clientWidth <= dragContainer.clientWidth) {
              dragItem.style.top = newTop + "px";
              dragItem.style.left = newLeft + "px";
            }
          }
      
          function dragEnd(event) {
            event.preventDefault();
            document.removeEventListener("mousemove", drag);
            document.removeEventListener("mouseup", dragEnd);
      
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/save-item-position/");
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            xhr.onload = function() {
              if (xhr.status === 200) {
                console.log('Item position saved successfully');
              } else {
                console.log('Error saving item position');
              }
            };
            xhr.send(JSON.stringify({
              "x": dragItem.offsetLeft,
              "y": dragItem.offsetTop
            }));
          }
        }
      </script>


</div>

<script>
    window.onload=showImages();

    function showImages() {
        var num = {{treeNum}};
        var imageContainer = document.getElementById("image-container");
        imageContainer.innerHTML = "";
        for (var i = 1; i <= num; i++) {
            var img = document.createElement("img");
            img.src = "{% static "images/smallTree.png" %}";
            imageContainer.appendChild(img);
        }
    }
</script>

{% endblock %}